<!DOCTYPE html>
<html lang='ja'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Coverage: nskk-thread-pool.el</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Monaco', 'Courier New', monospace; background: #f5f5f5; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; }
    .header h1 { font-size: 24px; margin-bottom: 10px; }
    .header .stats { font-size: 14px; opacity: 0.9; }
    .header a { color: white; text-decoration: underline; }
    .container { max-width: 1400px; margin: 20px auto; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; }
    td.line-number { background: #f0f0f0; color: #666; padding: 2px 10px; text-align: right; border-right: 2px solid #ddd; user-select: none; width: 60px; }
    td.line-content { padding: 2px 10px; white-space: pre; }
    tr.covered { background: #e8f5e9; }
    tr.uncovered { background: #ffebee; }
    tr.onevalue { background: #fff3e0; }
    tr.noreturn { background: #f3e5f5; }
    tr:hover { opacity: 0.9; }
    .legend { padding: 15px 30px; background: #fafafa; border-top: 1px solid #e0e0e0; font-size: 12px; }
    .legend-item { display: inline-block; margin-right: 20px; }
    .legend-color { display: inline-block; width: 20px; height: 12px; margin-right: 5px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class='header'>
    <h1>nskk-thread-pool.el</h1>
    <div class='stats'>
      Coverage: 100.00% (375/375 forms) •
      <a href='index.html'>← Back to Index</a>
    </div>
  </div>
  <div class='container'>
    <table>
<tr class=''><td class='line-number'>1</td><td class='line-content'>;;; nskk-thread-pool.el --- Thread pool implementation for NSKK -*- lexical-binding: t; -*-</td></tr>
<tr class=''><td class='line-number'>2</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>3</td><td class='line-content'>;; Copyright (C) 2025 NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>4</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>5</td><td class='line-content'>;; Author: NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>6</td><td class='line-content'>;; Maintainer: NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>7</td><td class='line-content'>;; Keywords: japanese, input-method, skk, threading</td></tr>
<tr class=''><td class='line-number'>8</td><td class='line-content'>;; Package-Requires: ((emacs &amp;quot;31.0&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>9</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>10</td><td class='line-content'>;;; Commentary:</td></tr>
<tr class=''><td class='line-number'>11</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>12</td><td class='line-content'>;; このファイルは、Emacs 31のネイティブスレッド機能を活用した</td></tr>
<tr class=''><td class='line-number'>13</td><td class='line-content'>;; スレッドプール実装を提供します。</td></tr>
<tr class=''><td class='line-number'>14</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>15</td><td class='line-content'>;; 主な機能:</td></tr>
<tr class=''><td class='line-number'>16</td><td class='line-content'>;; - ワーカースレッド管理</td></tr>
<tr class=''><td class='line-number'>17</td><td class='line-content'>;; - タスクキュー (FIFO)</td></tr>
<tr class=''><td class='line-number'>18</td><td class='line-content'>;; - スレッド生存期管理</td></tr>
<tr class=''><td class='line-number'>19</td><td class='line-content'>;; - CPUコア数自動調整</td></tr>
<tr class=''><td class='line-number'>20</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>21</td><td class='line-content'>;; 使用例:</td></tr>
<tr class=''><td class='line-number'>22</td><td class='line-content'>;;   (let ((pool (nskk-thread-pool-create)))</td></tr>
<tr class=''><td class='line-number'>23</td><td class='line-content'>;;     (nskk-thread-submit pool</td></tr>
<tr class=''><td class='line-number'>24</td><td class='line-content'>;;                         (lambda () (+ 1 2))</td></tr>
<tr class=''><td class='line-number'>25</td><td class='line-content'>;;                         (lambda (result) (message &amp;quot;Result: %s&amp;quot; result)))</td></tr>
<tr class=''><td class='line-number'>26</td><td class='line-content'>;;     (nskk-thread-pool-shutdown pool))</td></tr>
<tr class=''><td class='line-number'>27</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>28</td><td class='line-content'>;;; Code:</td></tr>
<tr class=''><td class='line-number'>29</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>30</td><td class='line-content'>(require 'cl-lib)</td></tr>
<tr class=''><td class='line-number'>31</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>32</td><td class='line-content'>;;; カスタマイズ変数</td></tr>
<tr class=''><td class='line-number'>33</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>34</td><td class='line-content'>(defgroup nskk-thread-pool nil</td></tr>
<tr class=''><td class='line-number'>35</td><td class='line-content'>  &amp;quot;NSKK スレッドプール設定。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>36</td><td class='line-content'>  :group 'nskk</td></tr>
<tr class=''><td class='line-number'>37</td><td class='line-content'>  :prefix &amp;quot;nskk-thread-pool-&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>38</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>39</td><td class='line-content'>(defcustom nskk-thread-pool-default-size nil</td></tr>
<tr class=''><td class='line-number'>40</td><td class='line-content'>  &amp;quot;デフォルトのスレッドプールサイズ。</td></tr>
<tr class=''><td class='line-number'>41</td><td class='line-content'>nilの場合、CPUコア数に基づいて自動設定される。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>42</td><td class='line-content'>  :type '(choice (const :tag &amp;quot;Auto&amp;quot; nil)</td></tr>
<tr class=''><td class='line-number'>43</td><td class='line-content'>                 (integer :tag &amp;quot;Fixed size&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>44</td><td class='line-content'>  :group 'nskk-thread-pool)</td></tr>
<tr class=''><td class='line-number'>45</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>46</td><td class='line-content'>(defcustom nskk-thread-pool-idle-timeout 60</td></tr>
<tr class=''><td class='line-number'>47</td><td class='line-content'>  &amp;quot;アイドル状態のワーカースレッドが終了するまでのタイムアウト秒数。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>48</td><td class='line-content'>  :type 'integer</td></tr>
<tr class=''><td class='line-number'>49</td><td class='line-content'>  :group 'nskk-thread-pool)</td></tr>
<tr class=''><td class='line-number'>50</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>51</td><td class='line-content'>(defcustom nskk-thread-pool-max-queue-size 1000</td></tr>
<tr class=''><td class='line-number'>52</td><td class='line-content'>  &amp;quot;タスクキューの最大サイズ。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>53</td><td class='line-content'>  :type 'integer</td></tr>
<tr class=''><td class='line-number'>54</td><td class='line-content'>  :group 'nskk-thread-pool)</td></tr>
<tr class=''><td class='line-number'>55</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>56</td><td class='line-content'>;;; データ構造</td></tr>
<tr class=''><td class='line-number'>57</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>58</td><td class='line-content'>(cl-defstruct (nskk-thread-pool</td></tr>
<tr class=''><td class='line-number'>59</td><td class='line-content'>               (:constructor nskk-thread-pool--create)</td></tr>
<tr class=''><td class='line-number'>60</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>61</td><td class='line-content'>  &amp;quot;スレッドプール構造体。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>62</td><td class='line-content'>  (size 0 :type integer :documentation &amp;quot;プールサイズ&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>63</td><td class='line-content'>  (workers nil :type list :documentation &amp;quot;ワーカースレッドリスト&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>64</td><td class='line-content'>  (task-queue nil :type list :documentation &amp;quot;タスクキュー&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>65</td><td class='line-content'>  (queue-mutex nil :documentation &amp;quot;キューmutex&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>66</td><td class='line-content'>  (queue-condition nil :documentation &amp;quot;キュー条件変数&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>67</td><td class='line-content'>  (shutdown-flag nil :type boolean :documentation &amp;quot;シャットダウンフラグ&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>68</td><td class='line-content'>  (active-count 0 :type integer :documentation &amp;quot;アクティブスレッド数&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>69</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>70</td><td class='line-content'>(cl-defstruct (nskk-thread-task</td></tr>
<tr class=''><td class='line-number'>71</td><td class='line-content'>               (:constructor nskk-thread-task-create)</td></tr>
<tr class=''><td class='line-number'>72</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>73</td><td class='line-content'>  &amp;quot;スレッドタスク構造体。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>74</td><td class='line-content'>  (function nil :type function :documentation &amp;quot;実行する関数&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>75</td><td class='line-content'>  (callback nil :documentation &amp;quot;完了時のコールバック&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>76</td><td class='line-content'>  (error-handler nil :documentation &amp;quot;エラーハンドラー&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>77</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>78</td><td class='line-content'>;;; ユーティリティ関数</td></tr>
<tr class=''><td class='line-number'>79</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>80</td><td class='line-content'>(defun nskk-thread-pool--get-cpu-count ()</td></tr>
<tr class=''><td class='line-number'>81</td><td class='line-content'>  &amp;quot;利用可能なCPUコア数を取得する。</td></tr>
<tr class=''><td class='line-number'>82</td><td class='line-content'>Emacs 31以降の`num-processors'を使用する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>83</td><td class='line-content'>  (if (fboundp 'num-processors)</td></tr>
<tr class='covered'><td class='line-number'>84</td><td class='line-content'>      (num-processors)</td></tr>
<tr class=''><td class='line-number'>85</td><td class='line-content'>    ;; フォールバック: 環境変数から取得を試みる</td></tr>
<tr class='covered'><td class='line-number'>86</td><td class='line-content'>    (or (ignore-errors</td></tr>
<tr class='covered'><td class='line-number'>87</td><td class='line-content'>          (string-to-number</td></tr>
<tr class='covered'><td class='line-number'>88</td><td class='line-content'>           (shell-command-to-string</td></tr>
<tr class='covered'><td class='line-number'>89</td><td class='line-content'>            (cond ((eq system-type 'darwin)</td></tr>
<tr class=''><td class='line-number'>90</td><td class='line-content'>                   &amp;quot;sysctl -n hw.ncpu&amp;quot;)</td></tr>
<tr class='covered'><td class='line-number'>91</td><td class='line-content'>                  ((eq system-type 'gnu/linux)</td></tr>
<tr class=''><td class='line-number'>92</td><td class='line-content'>                   &amp;quot;nproc&amp;quot;)</td></tr>
<tr class='covered'><td class='line-number'>93</td><td class='line-content'>                  (t &amp;quot;echo 4&amp;quot;)))))</td></tr>
<tr class='covered'><td class='line-number'>94</td><td class='line-content'>        4)))</td></tr>
<tr class=''><td class='line-number'>95</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>96</td><td class='line-content'>(defun nskk-thread-pool--optimal-size ()</td></tr>
<tr class=''><td class='line-number'>97</td><td class='line-content'>  &amp;quot;最適なスレッドプールサイズを計算する。</td></tr>
<tr class=''><td class='line-number'>98</td><td class='line-content'>CPUコア数に基づいて決定する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>99</td><td class='line-content'>  (let ((cpu-count (nskk-thread-pool--get-cpu-count)))</td></tr>
<tr class=''><td class='line-number'>100</td><td class='line-content'>    ;; CPUコア数と同じか、やや少なめに設定</td></tr>
<tr class='covered'><td class='line-number'>101</td><td class='line-content'>    (max 2 (min cpu-count 8))))</td></tr>
<tr class=''><td class='line-number'>102</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>103</td><td class='line-content'>;;; キュー操作</td></tr>
<tr class=''><td class='line-number'>104</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>105</td><td class='line-content'>(defun nskk-thread-pool--enqueue (pool task)</td></tr>
<tr class=''><td class='line-number'>106</td><td class='line-content'>  &amp;quot;POOL にタスク TASK をエンキューする。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>107</td><td class='line-content'>  (with-mutex (nskk-thread-pool-queue-mutex pool)</td></tr>
<tr class='covered'><td class='line-number'>108</td><td class='line-content'>    (when (&amp;gt;= (length (nskk-thread-pool-task-queue pool))</td></tr>
<tr class='covered'><td class='line-number'>109</td><td class='line-content'>              nskk-thread-pool-max-queue-size)</td></tr>
<tr class='covered'><td class='line-number'>110</td><td class='line-content'>      (error &amp;quot;Thread pool queue is full&amp;quot;))</td></tr>
<tr class='covered'><td class='line-number'>111</td><td class='line-content'>    (let ((queue (nskk-thread-pool-task-queue pool)))</td></tr>
<tr class='covered'><td class='line-number'>112</td><td class='line-content'>      (if queue</td></tr>
<tr class='covered'><td class='line-number'>113</td><td class='line-content'>          (setf (nskk-thread-pool-task-queue pool)</td></tr>
<tr class='covered'><td class='line-number'>114</td><td class='line-content'>                (nconc queue (list task)))</td></tr>
<tr class='covered'><td class='line-number'>115</td><td class='line-content'>        (setf (nskk-thread-pool-task-queue pool)</td></tr>
<tr class='covered'><td class='line-number'>116</td><td class='line-content'>              (list task))))</td></tr>
<tr class=''><td class='line-number'>117</td><td class='line-content'>    ;; 待機中のワーカーに通知</td></tr>
<tr class='covered'><td class='line-number'>118</td><td class='line-content'>    (condition-notify (nskk-thread-pool-queue-condition pool))))</td></tr>
<tr class=''><td class='line-number'>119</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>120</td><td class='line-content'>(defun nskk-thread-pool--dequeue (pool)</td></tr>
<tr class=''><td class='line-number'>121</td><td class='line-content'>  &amp;quot;POOL からタスクをデキューする。</td></tr>
<tr class=''><td class='line-number'>122</td><td class='line-content'>タスクがない場合は nil を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>123</td><td class='line-content'>  (let ((queue (nskk-thread-pool-task-queue pool)))</td></tr>
<tr class='covered'><td class='line-number'>124</td><td class='line-content'>    (when queue</td></tr>
<tr class='covered'><td class='line-number'>125</td><td class='line-content'>      (let ((task (car queue)))</td></tr>
<tr class='covered'><td class='line-number'>126</td><td class='line-content'>        (setf (nskk-thread-pool-task-queue pool) (cdr queue))</td></tr>
<tr class='covered'><td class='line-number'>127</td><td class='line-content'>        task))))</td></tr>
<tr class=''><td class='line-number'>128</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>129</td><td class='line-content'>;;; ワーカースレッド</td></tr>
<tr class=''><td class='line-number'>130</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>131</td><td class='line-content'>(defun nskk-thread-pool--worker-loop (pool worker-id)</td></tr>
<tr class=''><td class='line-number'>132</td><td class='line-content'>  &amp;quot;ワーカースレッドのメインループ。</td></tr>
<tr class=''><td class='line-number'>133</td><td class='line-content'>POOL はスレッドプール、WORKER-ID はワーカー識別子。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>134</td><td class='line-content'>  (cl-block nil</td></tr>
<tr class='covered'><td class='line-number'>135</td><td class='line-content'>    (while t</td></tr>
<tr class='covered'><td class='line-number'>136</td><td class='line-content'>      (let ((task nil)</td></tr>
<tr class=''><td class='line-number'>137</td><td class='line-content'>            (should-exit nil))</td></tr>
<tr class='covered'><td class='line-number'>138</td><td class='line-content'>        (with-mutex (nskk-thread-pool-queue-mutex pool)</td></tr>
<tr class='covered'><td class='line-number'>139</td><td class='line-content'>          (while (and (not (nskk-thread-pool-shutdown-flag pool))</td></tr>
<tr class='covered'><td class='line-number'>140</td><td class='line-content'>                      (null (nskk-thread-pool-task-queue pool)))</td></tr>
<tr class='covered'><td class='line-number'>141</td><td class='line-content'>            (condition-wait (nskk-thread-pool-queue-condition pool)))</td></tr>
<tr class='covered'><td class='line-number'>142</td><td class='line-content'>          (when (and (nskk-thread-pool-shutdown-flag pool)</td></tr>
<tr class='covered'><td class='line-number'>143</td><td class='line-content'>                     (null (nskk-thread-pool-task-queue pool)))</td></tr>
<tr class='covered'><td class='line-number'>144</td><td class='line-content'>            (setq should-exit t))</td></tr>
<tr class='covered'><td class='line-number'>145</td><td class='line-content'>          (unless should-exit</td></tr>
<tr class='covered'><td class='line-number'>146</td><td class='line-content'>            (setq task (nskk-thread-pool--dequeue pool))</td></tr>
<tr class='covered'><td class='line-number'>147</td><td class='line-content'>            (when task</td></tr>
<tr class='covered'><td class='line-number'>148</td><td class='line-content'>              (setf (nskk-thread-pool-active-count pool)</td></tr>
<tr class='covered'><td class='line-number'>149</td><td class='line-content'>                    (1+ (nskk-thread-pool-active-count pool))))))</td></tr>
<tr class='covered'><td class='line-number'>150</td><td class='line-content'>        (when should-exit</td></tr>
<tr class='covered'><td class='line-number'>151</td><td class='line-content'>          (cl-return nil))</td></tr>
<tr class='covered'><td class='line-number'>152</td><td class='line-content'>        (when task</td></tr>
<tr class='covered'><td class='line-number'>153</td><td class='line-content'>          (condition-case err</td></tr>
<tr class='covered'><td class='line-number'>154</td><td class='line-content'>              (let ((result (funcall (nskk-thread-task-function task))))</td></tr>
<tr class='covered'><td class='line-number'>155</td><td class='line-content'>                (when (nskk-thread-task-callback task)</td></tr>
<tr class='covered'><td class='line-number'>156</td><td class='line-content'>                  (funcall (nskk-thread-task-callback task) result)))</td></tr>
<tr class=''><td class='line-number'>157</td><td class='line-content'>            (error</td></tr>
<tr class='covered'><td class='line-number'>158</td><td class='line-content'>             (if (nskk-thread-task-error-handler task)</td></tr>
<tr class='covered'><td class='line-number'>159</td><td class='line-content'>                 (funcall (nskk-thread-task-error-handler task) err)</td></tr>
<tr class='covered'><td class='line-number'>160</td><td class='line-content'>               (message &amp;quot;Thread pool worker %d error: %S&amp;quot; worker-id err))))</td></tr>
<tr class='covered'><td class='line-number'>161</td><td class='line-content'>          (with-mutex (nskk-thread-pool-queue-mutex pool)</td></tr>
<tr class='covered'><td class='line-number'>162</td><td class='line-content'>            (setf (nskk-thread-pool-active-count pool)</td></tr>
<tr class='covered'><td class='line-number'>163</td><td class='line-content'>                  (max 0 (1- (nskk-thread-pool-active-count pool))))))))))</td></tr>
<tr class=''><td class='line-number'>164</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>165</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>166</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>167</td><td class='line-content'>(defun nskk-thread-pool--create-worker (pool worker-id)</td></tr>
<tr class=''><td class='line-number'>168</td><td class='line-content'>  &amp;quot;POOL のワーカースレッドを作成する。</td></tr>
<tr class=''><td class='line-number'>169</td><td class='line-content'>WORKER-ID はワーカー識別子。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>170</td><td class='line-content'>  (make-thread</td></tr>
<tr class=''><td class='line-number'>171</td><td class='line-content'>   (lambda ()</td></tr>
<tr class='covered'><td class='line-number'>172</td><td class='line-content'>     (nskk-thread-pool--worker-loop pool worker-id))</td></tr>
<tr class='covered'><td class='line-number'>173</td><td class='line-content'>   (format &amp;quot;nskk-worker-%d&amp;quot; worker-id)))</td></tr>
<tr class=''><td class='line-number'>174</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>175</td><td class='line-content'>;;; 公開API</td></tr>
<tr class=''><td class='line-number'>176</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>177</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>178</td><td class='line-content'>(defun nskk-thread-pool-create (&amp;optional size)</td></tr>
<tr class=''><td class='line-number'>179</td><td class='line-content'>  &amp;quot;スレッドプールを作成する。</td></tr>
<tr class=''><td class='line-number'>180</td><td class='line-content'>SIZE が指定されている場合はそのサイズ、</td></tr>
<tr class=''><td class='line-number'>181</td><td class='line-content'>そうでない場合はCPUコア数に基づいて自動調整される。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>182</td><td class='line-content'>  (interactive)</td></tr>
<tr class='covered'><td class='line-number'>183</td><td class='line-content'>  (let* ((pool-size (or size</td></tr>
<tr class='covered'><td class='line-number'>184</td><td class='line-content'>                        nskk-thread-pool-default-size</td></tr>
<tr class='covered'><td class='line-number'>185</td><td class='line-content'>                        (nskk-thread-pool--optimal-size)))</td></tr>
<tr class='covered'><td class='line-number'>186</td><td class='line-content'>         (queue-mutex (make-mutex &amp;quot;nskk-thread-pool-queue&amp;quot;))</td></tr>
<tr class='covered'><td class='line-number'>187</td><td class='line-content'>         (pool (nskk-thread-pool--create</td></tr>
<tr class='covered'><td class='line-number'>188</td><td class='line-content'>                :size pool-size</td></tr>
<tr class=''><td class='line-number'>189</td><td class='line-content'>                :task-queue nil</td></tr>
<tr class='covered'><td class='line-number'>190</td><td class='line-content'>                :queue-mutex queue-mutex</td></tr>
<tr class='covered'><td class='line-number'>191</td><td class='line-content'>                :queue-condition (make-condition-variable queue-mutex)</td></tr>
<tr class=''><td class='line-number'>192</td><td class='line-content'>                :shutdown-flag nil</td></tr>
<tr class='covered'><td class='line-number'>193</td><td class='line-content'>                :active-count 0)))</td></tr>
<tr class=''><td class='line-number'>194</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>195</td><td class='line-content'>    ;; ワーカースレッド生成</td></tr>
<tr class='covered'><td class='line-number'>196</td><td class='line-content'>    (dotimes (i pool-size)</td></tr>
<tr class='covered'><td class='line-number'>197</td><td class='line-content'>      (push (nskk-thread-pool--create-worker pool i)</td></tr>
<tr class='covered'><td class='line-number'>198</td><td class='line-content'>            (nskk-thread-pool-workers pool)))</td></tr>
<tr class=''><td class='line-number'>199</td><td class='line-content'></td></tr>
<tr class='covered'><td class='line-number'>200</td><td class='line-content'>    (message &amp;quot;Thread pool created with %d workers&amp;quot; pool-size)</td></tr>
<tr class='covered'><td class='line-number'>201</td><td class='line-content'>    pool))</td></tr>
<tr class=''><td class='line-number'>202</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>203</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>204</td><td class='line-content'>(defun nskk-thread-submit (pool task &amp;optional callback error-handler)</td></tr>
<tr class=''><td class='line-number'>205</td><td class='line-content'>  &amp;quot;POOL にタスク TASK を投入する。</td></tr>
<tr class=''><td class='line-number'>206</td><td class='line-content'>TASK は引数なしの関数。</td></tr>
<tr class=''><td class='line-number'>207</td><td class='line-content'>CALLBACK はタスク完了時に呼ばれる関数（オプション）。</td></tr>
<tr class=''><td class='line-number'>208</td><td class='line-content'>ERROR-HANDLER はエラー発生時に呼ばれる関数（オプション）。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>209</td><td class='line-content'>  (when (nskk-thread-pool-shutdown-flag pool)</td></tr>
<tr class='covered'><td class='line-number'>210</td><td class='line-content'>    (error &amp;quot;Cannot submit task to shutdown pool&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>211</td><td class='line-content'></td></tr>
<tr class='covered'><td class='line-number'>212</td><td class='line-content'>  (let ((thread-task (nskk-thread-task-create</td></tr>
<tr class='covered'><td class='line-number'>213</td><td class='line-content'>                      :function task</td></tr>
<tr class='covered'><td class='line-number'>214</td><td class='line-content'>                      :callback callback</td></tr>
<tr class='covered'><td class='line-number'>215</td><td class='line-content'>                      :error-handler error-handler)))</td></tr>
<tr class='covered'><td class='line-number'>216</td><td class='line-content'>    (nskk-thread-pool--enqueue pool thread-task)))</td></tr>
<tr class=''><td class='line-number'>217</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>218</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>219</td><td class='line-content'>(defun nskk-thread-pool-shutdown (pool &amp;optional wait)</td></tr>
<tr class=''><td class='line-number'>220</td><td class='line-content'>  &amp;quot;POOL をシャットダウンする。</td></tr>
<tr class=''><td class='line-number'>221</td><td class='line-content'>WAIT が non-nil の場合、全タスクの完了を待つ。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>222</td><td class='line-content'>  (interactive)</td></tr>
<tr class='covered'><td class='line-number'>223</td><td class='line-content'>  (setf (nskk-thread-pool-shutdown-flag pool) t)</td></tr>
<tr class=''><td class='line-number'>224</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>225</td><td class='line-content'>  ;; 全ワーカーに通知</td></tr>
<tr class='covered'><td class='line-number'>226</td><td class='line-content'>  (with-mutex (nskk-thread-pool-queue-mutex pool)</td></tr>
<tr class='covered'><td class='line-number'>227</td><td class='line-content'>    (condition-notify (nskk-thread-pool-queue-condition pool) t))</td></tr>
<tr class=''><td class='line-number'>228</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>229</td><td class='line-content'>  ;; 待機が指定されている場合</td></tr>
<tr class='covered'><td class='line-number'>230</td><td class='line-content'>  (when wait</td></tr>
<tr class='covered'><td class='line-number'>231</td><td class='line-content'>    (dolist (worker (nskk-thread-pool-workers pool))</td></tr>
<tr class='covered'><td class='line-number'>232</td><td class='line-content'>      (thread-join worker)))</td></tr>
<tr class=''><td class='line-number'>233</td><td class='line-content'></td></tr>
<tr class='covered'><td class='line-number'>234</td><td class='line-content'>  (message &amp;quot;Thread pool shutdown&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>235</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>236</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>237</td><td class='line-content'>(defun nskk-thread-pool-status (pool)</td></tr>
<tr class=''><td class='line-number'>238</td><td class='line-content'>  &amp;quot;POOL の状態を表示する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>239</td><td class='line-content'>  (interactive)</td></tr>
<tr class='covered'><td class='line-number'>240</td><td class='line-content'>  (message &amp;quot;Thread Pool Status:</td></tr>
<tr class=''><td class='line-number'>241</td><td class='line-content'>  Size: %d</td></tr>
<tr class=''><td class='line-number'>242</td><td class='line-content'>  Queue length: %d</td></tr>
<tr class=''><td class='line-number'>243</td><td class='line-content'>  Active: %d</td></tr>
<tr class=''><td class='line-number'>244</td><td class='line-content'>  Shutdown: %s&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>245</td><td class='line-content'>           (nskk-thread-pool-size pool)</td></tr>
<tr class='covered'><td class='line-number'>246</td><td class='line-content'>           (length (nskk-thread-pool-task-queue pool))</td></tr>
<tr class='covered'><td class='line-number'>247</td><td class='line-content'>           (nskk-thread-pool-active-count pool)</td></tr>
<tr class='covered'><td class='line-number'>248</td><td class='line-content'>           (if (nskk-thread-pool-shutdown-flag pool) &amp;quot;Yes&amp;quot; &amp;quot;No&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>249</td><td class='line-content'>  nil)</td></tr>
<tr class=''><td class='line-number'>250</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>251</td><td class='line-content'>;;; ヘルパー関数</td></tr>
<tr class=''><td class='line-number'>252</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>253</td><td class='line-content'>(defun nskk-thread-pool-wait-for-completion (pool timeout)</td></tr>
<tr class=''><td class='line-number'>254</td><td class='line-content'>  &amp;quot;POOL の全タスク完了を TIMEOUT 秒まで待機する。</td></tr>
<tr class=''><td class='line-number'>255</td><td class='line-content'>完了した場合 t を、タイムアウトした場合 nil を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>256</td><td class='line-content'>  (let ((start-time (current-time)))</td></tr>
<tr class='covered'><td class='line-number'>257</td><td class='line-content'>    (while (and (&amp;gt; (length (nskk-thread-pool-task-queue pool)) 0)</td></tr>
<tr class='covered'><td class='line-number'>258</td><td class='line-content'>                (&amp;lt; (float-time (time-subtract (current-time) start-time))</td></tr>
<tr class='covered'><td class='line-number'>259</td><td class='line-content'>                   timeout))</td></tr>
<tr class='covered'><td class='line-number'>260</td><td class='line-content'>      (sleep-for 0.1))</td></tr>
<tr class='covered'><td class='line-number'>261</td><td class='line-content'>    (= (length (nskk-thread-pool-task-queue pool)) 0)))</td></tr>
<tr class=''><td class='line-number'>262</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>263</td><td class='line-content'>(defun nskk-thread-pool-available-p ()</td></tr>
<tr class=''><td class='line-number'>264</td><td class='line-content'>  &amp;quot;スレッド機能が利用可能かチェックする。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>265</td><td class='line-content'>  (and (fboundp 'make-thread)</td></tr>
<tr class='covered'><td class='line-number'>266</td><td class='line-content'>       (fboundp 'make-mutex)</td></tr>
<tr class='covered'><td class='line-number'>267</td><td class='line-content'>       (fboundp 'make-condition-variable)))</td></tr>
<tr class=''><td class='line-number'>268</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>269</td><td class='line-content'>(provide 'nskk-thread-pool)</td></tr>
<tr class=''><td class='line-number'>270</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>271</td><td class='line-content'>;;; nskk-thread-pool.el ends here</td></tr>

    </table>
  </div>
  <div class='legend'>
    <div class='legend-item'><span class='legend-color' style='background: #e8f5e9;'></span>Covered</div>
    <div class='legend-item'><span class='legend-color' style='background: #ffebee;'></span>Uncovered</div>
    <div class='legend-item'><span class='legend-color' style='background: #fff3e0;'></span>1-Value</div>
    <div class='legend-item'><span class='legend-color' style='background: #f3e5f5;'></span>No-Return</div>
  </div>
</body>
</html>