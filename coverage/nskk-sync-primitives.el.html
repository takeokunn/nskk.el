<!DOCTYPE html>
<html lang='ja'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Coverage: nskk-sync-primitives.el</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Monaco', 'Courier New', monospace; background: #f5f5f5; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; }
    .header h1 { font-size: 24px; margin-bottom: 10px; }
    .header .stats { font-size: 14px; opacity: 0.9; }
    .header a { color: white; text-decoration: underline; }
    .container { max-width: 1400px; margin: 20px auto; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; }
    td.line-number { background: #f0f0f0; color: #666; padding: 2px 10px; text-align: right; border-right: 2px solid #ddd; user-select: none; width: 60px; }
    td.line-content { padding: 2px 10px; white-space: pre; }
    tr.covered { background: #e8f5e9; }
    tr.uncovered { background: #ffebee; }
    tr.onevalue { background: #fff3e0; }
    tr.noreturn { background: #f3e5f5; }
    tr:hover { opacity: 0.9; }
    .legend { padding: 15px 30px; background: #fafafa; border-top: 1px solid #e0e0e0; font-size: 12px; }
    .legend-item { display: inline-block; margin-right: 20px; }
    .legend-color { display: inline-block; width: 20px; height: 12px; margin-right: 5px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class='header'>
    <h1>nskk-sync-primitives.el</h1>
    <div class='stats'>
      Coverage: 100.00% (385/385 forms) •
      <a href='index.html'>← Back to Index</a>
    </div>
  </div>
  <div class='container'>
    <table>
<tr class=''><td class='line-number'>1</td><td class='line-content'>;;; nskk-sync-primitives.el --- Synchronization primitives for NSKK -*- lexical-binding: t; -*-</td></tr>
<tr class=''><td class='line-number'>2</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>3</td><td class='line-content'>;; Copyright (C) 2025 NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>4</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>5</td><td class='line-content'>;; Author: NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>6</td><td class='line-content'>;; Maintainer: NSKK Development Team</td></tr>
<tr class=''><td class='line-number'>7</td><td class='line-content'>;; Keywords: japanese, input-method, skk, threading, synchronization</td></tr>
<tr class=''><td class='line-number'>8</td><td class='line-content'>;; Package-Requires: ((emacs &amp;quot;31.0&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>9</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>10</td><td class='line-content'>;;; Commentary:</td></tr>
<tr class=''><td class='line-number'>11</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>12</td><td class='line-content'>;; このファイルは、スレッド間同期のためのプリミティブを実装します。</td></tr>
<tr class=''><td class='line-number'>13</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>14</td><td class='line-content'>;; 主な機能:</td></tr>
<tr class=''><td class='line-number'>15</td><td class='line-content'>;; - Mutex実装（Emacs 31の`make-mutex`使用）</td></tr>
<tr class=''><td class='line-number'>16</td><td class='line-content'>;; - Condition Variable</td></tr>
<tr class=''><td class='line-number'>17</td><td class='line-content'>;; - Read-Write Lock</td></tr>
<tr class=''><td class='line-number'>18</td><td class='line-content'>;; - Atomic Operations</td></tr>
<tr class=''><td class='line-number'>19</td><td class='line-content'>;; - Semaphore</td></tr>
<tr class=''><td class='line-number'>20</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>21</td><td class='line-content'>;; 使用例:</td></tr>
<tr class=''><td class='line-number'>22</td><td class='line-content'>;;   ;; Mutex</td></tr>
<tr class=''><td class='line-number'>23</td><td class='line-content'>;;   (nskk-with-mutex my-mutex</td></tr>
<tr class=''><td class='line-number'>24</td><td class='line-content'>;;     (setq counter (1+ counter)))</td></tr>
<tr class=''><td class='line-number'>25</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>26</td><td class='line-content'>;;   ;; Read-Write Lock</td></tr>
<tr class=''><td class='line-number'>27</td><td class='line-content'>;;   (nskk-with-read-lock my-rwlock</td></tr>
<tr class=''><td class='line-number'>28</td><td class='line-content'>;;     (message &amp;quot;Value: %s&amp;quot; shared-value))</td></tr>
<tr class=''><td class='line-number'>29</td><td class='line-content'>;;</td></tr>
<tr class=''><td class='line-number'>30</td><td class='line-content'>;;   ;; Atomic操作</td></tr>
<tr class=''><td class='line-number'>31</td><td class='line-content'>;;   (nskk-atomic-increment counter-atom)</td></tr>
<tr class=''><td class='line-number'>32</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>33</td><td class='line-content'>;;; Code:</td></tr>
<tr class=''><td class='line-number'>34</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>35</td><td class='line-content'>(require 'cl-lib)</td></tr>
<tr class=''><td class='line-number'>36</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>37</td><td class='line-content'>;;; Mutex拡張</td></tr>
<tr class=''><td class='line-number'>38</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>39</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>40</td><td class='line-content'>(defmacro nskk-with-mutex (mutex &amp;rest body)</td></tr>
<tr class=''><td class='line-number'>41</td><td class='line-content'>  &amp;quot;MUTEX をロックして BODY を実行する。</td></tr>
<tr class=''><td class='line-number'>42</td><td class='line-content'>実行後、必ず MUTEX をアンロックする。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>43</td><td class='line-content'>  (declare (indent 1) (debug t))</td></tr>
<tr class='covered'><td class='line-number'>44</td><td class='line-content'>  `(with-mutex ,mutex</td></tr>
<tr class='covered'><td class='line-number'>45</td><td class='line-content'>     ,@body))</td></tr>
<tr class=''><td class='line-number'>46</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>47</td><td class='line-content'>;;; Read-Write Lock</td></tr>
<tr class=''><td class='line-number'>48</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>49</td><td class='line-content'>(cl-defstruct (nskk-rwlock</td></tr>
<tr class=''><td class='line-number'>50</td><td class='line-content'>               (:constructor nskk-rwlock--create)</td></tr>
<tr class=''><td class='line-number'>51</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>52</td><td class='line-content'>  &amp;quot;Read-Write Lock 構造体。</td></tr>
<tr class=''><td class='line-number'>53</td><td class='line-content'>複数の読み取りスレッドを許可するが、書き込みは排他的に実行する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>54</td><td class='line-content'>  (mutex nil :documentation &amp;quot;内部mutex&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>55</td><td class='line-content'>  (read-count 0 :type integer :documentation &amp;quot;読み取りスレッド数&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>56</td><td class='line-content'>  (write-mutex nil :documentation &amp;quot;書き込み用mutex&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>57</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>58</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>59</td><td class='line-content'>(defun nskk-rwlock-create ()</td></tr>
<tr class=''><td class='line-number'>60</td><td class='line-content'>  &amp;quot;Read-Write Lock を作成する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>61</td><td class='line-content'>  (nskk-rwlock--create</td></tr>
<tr class='covered'><td class='line-number'>62</td><td class='line-content'>   :mutex (make-mutex)</td></tr>
<tr class=''><td class='line-number'>63</td><td class='line-content'>   :read-count 0</td></tr>
<tr class='covered'><td class='line-number'>64</td><td class='line-content'>   :write-mutex (make-mutex)))</td></tr>
<tr class=''><td class='line-number'>65</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>66</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>67</td><td class='line-content'>(defun nskk-rwlock-read-lock (rwlock)</td></tr>
<tr class=''><td class='line-number'>68</td><td class='line-content'>  &amp;quot;RWLOCK の読み取りロックを取得する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>69</td><td class='line-content'>  (with-mutex (nskk-rwlock-mutex rwlock)</td></tr>
<tr class='covered'><td class='line-number'>70</td><td class='line-content'>    (setf (nskk-rwlock-read-count rwlock)</td></tr>
<tr class='covered'><td class='line-number'>71</td><td class='line-content'>          (1+ (nskk-rwlock-read-count rwlock)))</td></tr>
<tr class=''><td class='line-number'>72</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>73</td><td class='line-content'>    ;; 最初の読み取りスレッドの場合、書き込みをブロック</td></tr>
<tr class='covered'><td class='line-number'>74</td><td class='line-content'>    (when (= (nskk-rwlock-read-count rwlock) 1)</td></tr>
<tr class='covered'><td class='line-number'>75</td><td class='line-content'>      (mutex-lock (nskk-rwlock-write-mutex rwlock)))))</td></tr>
<tr class=''><td class='line-number'>76</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>77</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>78</td><td class='line-content'>(defun nskk-rwlock-read-unlock (rwlock)</td></tr>
<tr class=''><td class='line-number'>79</td><td class='line-content'>  &amp;quot;RWLOCK の読み取りロックを解放する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>80</td><td class='line-content'>  (with-mutex (nskk-rwlock-mutex rwlock)</td></tr>
<tr class='covered'><td class='line-number'>81</td><td class='line-content'>    (setf (nskk-rwlock-read-count rwlock)</td></tr>
<tr class='covered'><td class='line-number'>82</td><td class='line-content'>          (1- (nskk-rwlock-read-count rwlock)))</td></tr>
<tr class=''><td class='line-number'>83</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>84</td><td class='line-content'>    ;; 最後の読み取りスレッドの場合、書き込みを許可</td></tr>
<tr class='covered'><td class='line-number'>85</td><td class='line-content'>    (when (= (nskk-rwlock-read-count rwlock) 0)</td></tr>
<tr class='covered'><td class='line-number'>86</td><td class='line-content'>      (mutex-unlock (nskk-rwlock-write-mutex rwlock)))))</td></tr>
<tr class=''><td class='line-number'>87</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>88</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>89</td><td class='line-content'>(defun nskk-rwlock-write-lock (rwlock)</td></tr>
<tr class=''><td class='line-number'>90</td><td class='line-content'>  &amp;quot;RWLOCK の書き込みロックを取得する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>91</td><td class='line-content'>  (mutex-lock (nskk-rwlock-write-mutex rwlock)))</td></tr>
<tr class=''><td class='line-number'>92</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>93</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>94</td><td class='line-content'>(defun nskk-rwlock-write-unlock (rwlock)</td></tr>
<tr class=''><td class='line-number'>95</td><td class='line-content'>  &amp;quot;RWLOCK の書き込みロックを解放する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>96</td><td class='line-content'>  (mutex-unlock (nskk-rwlock-write-mutex rwlock)))</td></tr>
<tr class=''><td class='line-number'>97</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>98</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>99</td><td class='line-content'>(defmacro nskk-with-read-lock (rwlock &amp;rest body)</td></tr>
<tr class=''><td class='line-number'>100</td><td class='line-content'>  &amp;quot;RWLOCK の読み取りロックを取得して BODY を実行する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>101</td><td class='line-content'>  (declare (indent 1) (debug t))</td></tr>
<tr class='covered'><td class='line-number'>102</td><td class='line-content'>  `(progn</td></tr>
<tr class='covered'><td class='line-number'>103</td><td class='line-content'>     (nskk-rwlock-read-lock ,rwlock)</td></tr>
<tr class=''><td class='line-number'>104</td><td class='line-content'>     (unwind-protect</td></tr>
<tr class='covered'><td class='line-number'>105</td><td class='line-content'>         (progn ,@body)</td></tr>
<tr class='covered'><td class='line-number'>106</td><td class='line-content'>       (nskk-rwlock-read-unlock ,rwlock))))</td></tr>
<tr class=''><td class='line-number'>107</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>108</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>109</td><td class='line-content'>(defmacro nskk-with-write-lock (rwlock &amp;rest body)</td></tr>
<tr class=''><td class='line-number'>110</td><td class='line-content'>  &amp;quot;RWLOCK の書き込みロックを取得して BODY を実行する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>111</td><td class='line-content'>  (declare (indent 1) (debug t))</td></tr>
<tr class='covered'><td class='line-number'>112</td><td class='line-content'>  `(progn</td></tr>
<tr class='covered'><td class='line-number'>113</td><td class='line-content'>     (nskk-rwlock-write-lock ,rwlock)</td></tr>
<tr class=''><td class='line-number'>114</td><td class='line-content'>     (unwind-protect</td></tr>
<tr class='covered'><td class='line-number'>115</td><td class='line-content'>         (progn ,@body)</td></tr>
<tr class='covered'><td class='line-number'>116</td><td class='line-content'>       (nskk-rwlock-write-unlock ,rwlock))))</td></tr>
<tr class=''><td class='line-number'>117</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>118</td><td class='line-content'>;;; Semaphore</td></tr>
<tr class=''><td class='line-number'>119</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>120</td><td class='line-content'>(cl-defstruct (nskk-semaphore</td></tr>
<tr class=''><td class='line-number'>121</td><td class='line-content'>               (:constructor nskk-semaphore--create)</td></tr>
<tr class=''><td class='line-number'>122</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>123</td><td class='line-content'>  &amp;quot;Semaphore 構造体。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>124</td><td class='line-content'>  (count 0 :type integer :documentation &amp;quot;利用可能リソース数&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>125</td><td class='line-content'>  (mutex nil :documentation &amp;quot;内部mutex&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>126</td><td class='line-content'>  (condition nil :documentation &amp;quot;条件変数&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>127</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>128</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>129</td><td class='line-content'>(defun nskk-semaphore-create (initial-count)</td></tr>
<tr class=''><td class='line-number'>130</td><td class='line-content'>  &amp;quot;初期カウント INITIAL-COUNT の Semaphore を作成する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>131</td><td class='line-content'>  (let ((mutex (make-mutex)))</td></tr>
<tr class='covered'><td class='line-number'>132</td><td class='line-content'>    (nskk-semaphore--create</td></tr>
<tr class='covered'><td class='line-number'>133</td><td class='line-content'>     :count initial-count</td></tr>
<tr class='covered'><td class='line-number'>134</td><td class='line-content'>     :mutex mutex</td></tr>
<tr class='covered'><td class='line-number'>135</td><td class='line-content'>     :condition (make-condition-variable mutex))))</td></tr>
<tr class=''><td class='line-number'>136</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>137</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>138</td><td class='line-content'>(defun nskk-semaphore-wait (semaphore &amp;optional timeout)</td></tr>
<tr class=''><td class='line-number'>139</td><td class='line-content'>  &amp;quot;SEMAPHORE を取得する。</td></tr>
<tr class=''><td class='line-number'>140</td><td class='line-content'>TIMEOUT が指定されている場合、その秒数だけ待機する。</td></tr>
<tr class=''><td class='line-number'>141</td><td class='line-content'>成功した場合 t、タイムアウトした場合 nil を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>142</td><td class='line-content'>  (let ((deadline (when timeout (+ (float-time) timeout))))</td></tr>
<tr class='covered'><td class='line-number'>143</td><td class='line-content'>    (catch 'nskk-semaphore-done</td></tr>
<tr class='covered'><td class='line-number'>144</td><td class='line-content'>      (while t</td></tr>
<tr class='covered'><td class='line-number'>145</td><td class='line-content'>        (with-mutex (nskk-semaphore-mutex semaphore)</td></tr>
<tr class='covered'><td class='line-number'>146</td><td class='line-content'>          (when (&amp;gt; (nskk-semaphore-count semaphore) 0)</td></tr>
<tr class='covered'><td class='line-number'>147</td><td class='line-content'>            (setf (nskk-semaphore-count semaphore)</td></tr>
<tr class='covered'><td class='line-number'>148</td><td class='line-content'>                  (1- (nskk-semaphore-count semaphore)))</td></tr>
<tr class='covered'><td class='line-number'>149</td><td class='line-content'>            (throw 'nskk-semaphore-done t))</td></tr>
<tr class='covered'><td class='line-number'>150</td><td class='line-content'>          (unless timeout</td></tr>
<tr class='covered'><td class='line-number'>151</td><td class='line-content'>            (condition-wait (nskk-semaphore-condition semaphore))))</td></tr>
<tr class='covered'><td class='line-number'>152</td><td class='line-content'>        (if timeout</td></tr>
<tr class='covered'><td class='line-number'>153</td><td class='line-content'>            (let ((remaining (- deadline (float-time))))</td></tr>
<tr class='covered'><td class='line-number'>154</td><td class='line-content'>              (when (&amp;lt;= remaining 0)</td></tr>
<tr class='covered'><td class='line-number'>155</td><td class='line-content'>                (throw 'nskk-semaphore-done nil))</td></tr>
<tr class='covered'><td class='line-number'>156</td><td class='line-content'>              (sleep-for (min remaining 0.01)))</td></tr>
<tr class=''><td class='line-number'>157</td><td class='line-content'>          ;; 無制限待機の場合はここに到達しない (condition-wait で待機)</td></tr>
<tr class='covered'><td class='line-number'>158</td><td class='line-content'>          )))))</td></tr>
<tr class=''><td class='line-number'>159</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>160</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>161</td><td class='line-content'>(defun nskk-semaphore-post (semaphore)</td></tr>
<tr class=''><td class='line-number'>162</td><td class='line-content'>  &amp;quot;SEMAPHORE を解放する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>163</td><td class='line-content'>  (with-mutex (nskk-semaphore-mutex semaphore)</td></tr>
<tr class='covered'><td class='line-number'>164</td><td class='line-content'>    (setf (nskk-semaphore-count semaphore)</td></tr>
<tr class='covered'><td class='line-number'>165</td><td class='line-content'>          (1+ (nskk-semaphore-count semaphore)))</td></tr>
<tr class='covered'><td class='line-number'>166</td><td class='line-content'>    (condition-notify (nskk-semaphore-condition semaphore))))</td></tr>
<tr class=''><td class='line-number'>167</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>168</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>169</td><td class='line-content'>(defmacro nskk-with-semaphore (semaphore &amp;rest body)</td></tr>
<tr class=''><td class='line-number'>170</td><td class='line-content'>  &amp;quot;SEMAPHORE を取得して BODY を実行する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>171</td><td class='line-content'>  (declare (indent 1) (debug t))</td></tr>
<tr class='covered'><td class='line-number'>172</td><td class='line-content'>  `(progn</td></tr>
<tr class='covered'><td class='line-number'>173</td><td class='line-content'>     (nskk-semaphore-wait ,semaphore)</td></tr>
<tr class=''><td class='line-number'>174</td><td class='line-content'>     (unwind-protect</td></tr>
<tr class='covered'><td class='line-number'>175</td><td class='line-content'>         (progn ,@body)</td></tr>
<tr class='covered'><td class='line-number'>176</td><td class='line-content'>       (nskk-semaphore-post ,semaphore))))</td></tr>
<tr class=''><td class='line-number'>177</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>178</td><td class='line-content'>;;; Atomic Operations</td></tr>
<tr class=''><td class='line-number'>179</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>180</td><td class='line-content'>(cl-defstruct (nskk-atomic</td></tr>
<tr class=''><td class='line-number'>181</td><td class='line-content'>               (:constructor nskk-atomic--create)</td></tr>
<tr class=''><td class='line-number'>182</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>183</td><td class='line-content'>  &amp;quot;Atomic 変数構造体。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>184</td><td class='line-content'>  (value nil :documentation &amp;quot;保持する値&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>185</td><td class='line-content'>  (mutex nil :documentation &amp;quot;内部mutex&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>186</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>187</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>188</td><td class='line-content'>(defun nskk-atomic-create (initial-value)</td></tr>
<tr class=''><td class='line-number'>189</td><td class='line-content'>  &amp;quot;初期値 INITIAL-VALUE のアトミック変数を作成する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>190</td><td class='line-content'>  (nskk-atomic--create</td></tr>
<tr class='covered'><td class='line-number'>191</td><td class='line-content'>   :value initial-value</td></tr>
<tr class='covered'><td class='line-number'>192</td><td class='line-content'>   :mutex (make-mutex)))</td></tr>
<tr class=''><td class='line-number'>193</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>194</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>195</td><td class='line-content'>(defun nskk-atomic-get (atom)</td></tr>
<tr class=''><td class='line-number'>196</td><td class='line-content'>  &amp;quot;ATOM の値を取得する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>197</td><td class='line-content'>  (with-mutex (nskk-atomic-mutex atom)</td></tr>
<tr class='covered'><td class='line-number'>198</td><td class='line-content'>    (nskk-atomic-value atom)))</td></tr>
<tr class=''><td class='line-number'>199</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>200</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>201</td><td class='line-content'>(defun nskk-atomic-set (atom new-value)</td></tr>
<tr class=''><td class='line-number'>202</td><td class='line-content'>  &amp;quot;ATOM に NEW-VALUE を設定する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>203</td><td class='line-content'>  (with-mutex (nskk-atomic-mutex atom)</td></tr>
<tr class='covered'><td class='line-number'>204</td><td class='line-content'>    (setf (nskk-atomic-value atom) new-value)))</td></tr>
<tr class=''><td class='line-number'>205</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>206</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>207</td><td class='line-content'>(defun nskk-atomic-compare-and-swap (atom expected new-value)</td></tr>
<tr class=''><td class='line-number'>208</td><td class='line-content'>  &amp;quot;ATOM が EXPECTED と等しい場合、NEW-VALUE に設定する。</td></tr>
<tr class=''><td class='line-number'>209</td><td class='line-content'>成功した場合 t、失敗した場合 nil を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>210</td><td class='line-content'>  (with-mutex (nskk-atomic-mutex atom)</td></tr>
<tr class='covered'><td class='line-number'>211</td><td class='line-content'>    (if (equal (nskk-atomic-value atom) expected)</td></tr>
<tr class='covered'><td class='line-number'>212</td><td class='line-content'>        (progn</td></tr>
<tr class='covered'><td class='line-number'>213</td><td class='line-content'>          (setf (nskk-atomic-value atom) new-value)</td></tr>
<tr class='covered'><td class='line-number'>214</td><td class='line-content'>          t)</td></tr>
<tr class='covered'><td class='line-number'>215</td><td class='line-content'>      nil)))</td></tr>
<tr class=''><td class='line-number'>216</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>217</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>218</td><td class='line-content'>(defun nskk-atomic-increment (atom &amp;optional delta)</td></tr>
<tr class=''><td class='line-number'>219</td><td class='line-content'>  &amp;quot;ATOM の値を DELTA だけ増やす（デフォルトは1）。</td></tr>
<tr class=''><td class='line-number'>220</td><td class='line-content'>新しい値を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>221</td><td class='line-content'>  (with-mutex (nskk-atomic-mutex atom)</td></tr>
<tr class='covered'><td class='line-number'>222</td><td class='line-content'>    (let ((new-value (+ (nskk-atomic-value atom) (or delta 1))))</td></tr>
<tr class='covered'><td class='line-number'>223</td><td class='line-content'>      (setf (nskk-atomic-value atom) new-value)</td></tr>
<tr class='covered'><td class='line-number'>224</td><td class='line-content'>      new-value)))</td></tr>
<tr class=''><td class='line-number'>225</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>226</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>227</td><td class='line-content'>(defun nskk-atomic-decrement (atom &amp;optional delta)</td></tr>
<tr class=''><td class='line-number'>228</td><td class='line-content'>  &amp;quot;ATOM の値を DELTA だけ減らす（デフォルトは1）。</td></tr>
<tr class=''><td class='line-number'>229</td><td class='line-content'>新しい値を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>230</td><td class='line-content'>  (nskk-atomic-increment atom (- (or delta 1))))</td></tr>
<tr class=''><td class='line-number'>231</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>232</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>233</td><td class='line-content'>(defun nskk-atomic-update (atom update-fn)</td></tr>
<tr class=''><td class='line-number'>234</td><td class='line-content'>  &amp;quot;UPDATE-FN を使って ATOM の値を更新する。</td></tr>
<tr class=''><td class='line-number'>235</td><td class='line-content'>UPDATE-FN は現在の値を受け取り、新しい値を返す関数。</td></tr>
<tr class=''><td class='line-number'>236</td><td class='line-content'>新しい値を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>237</td><td class='line-content'>  (with-mutex (nskk-atomic-mutex atom)</td></tr>
<tr class='covered'><td class='line-number'>238</td><td class='line-content'>    (let ((new-value (funcall update-fn (nskk-atomic-value atom))))</td></tr>
<tr class='covered'><td class='line-number'>239</td><td class='line-content'>      (setf (nskk-atomic-value atom) new-value)</td></tr>
<tr class='covered'><td class='line-number'>240</td><td class='line-content'>      new-value)))</td></tr>
<tr class=''><td class='line-number'>241</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>242</td><td class='line-content'>;;; Barrier</td></tr>
<tr class=''><td class='line-number'>243</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>244</td><td class='line-content'>(cl-defstruct (nskk-barrier</td></tr>
<tr class=''><td class='line-number'>245</td><td class='line-content'>               (:constructor nskk-barrier--create)</td></tr>
<tr class=''><td class='line-number'>246</td><td class='line-content'>               (:copier nil))</td></tr>
<tr class=''><td class='line-number'>247</td><td class='line-content'>  &amp;quot;Barrier 構造体。</td></tr>
<tr class=''><td class='line-number'>248</td><td class='line-content'>指定された数のスレッドが到達するまで待機する。&amp;quot;</td></tr>
<tr class=''><td class='line-number'>249</td><td class='line-content'>  (count 0 :type integer :documentation &amp;quot;待機スレッド数&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>250</td><td class='line-content'>  (threshold 0 :type integer :documentation &amp;quot;バリア閾値&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>251</td><td class='line-content'>  (mutex nil :documentation &amp;quot;内部mutex&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>252</td><td class='line-content'>  (condition nil :documentation &amp;quot;条件変数&amp;quot;))</td></tr>
<tr class=''><td class='line-number'>253</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>254</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>255</td><td class='line-content'>(defun nskk-barrier-create (threshold)</td></tr>
<tr class=''><td class='line-number'>256</td><td class='line-content'>  &amp;quot;THRESHOLD 個のスレッドが到達するまで待機する Barrier を作成する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>257</td><td class='line-content'>  (let ((mutex (make-mutex)))</td></tr>
<tr class='covered'><td class='line-number'>258</td><td class='line-content'>    (nskk-barrier--create</td></tr>
<tr class=''><td class='line-number'>259</td><td class='line-content'>     :count 0</td></tr>
<tr class='covered'><td class='line-number'>260</td><td class='line-content'>     :threshold threshold</td></tr>
<tr class='covered'><td class='line-number'>261</td><td class='line-content'>     :mutex mutex</td></tr>
<tr class='covered'><td class='line-number'>262</td><td class='line-content'>     :condition (make-condition-variable mutex))))</td></tr>
<tr class=''><td class='line-number'>263</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>264</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>265</td><td class='line-content'>(defun nskk-barrier-wait (barrier)</td></tr>
<tr class=''><td class='line-number'>266</td><td class='line-content'>  &amp;quot;BARRIER に到達し、全スレッドが到達するまで待機する。</td></tr>
<tr class=''><td class='line-number'>267</td><td class='line-content'>最後のスレッドの場合 t、それ以外は nil を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>268</td><td class='line-content'>  (with-mutex (nskk-barrier-mutex barrier)</td></tr>
<tr class='covered'><td class='line-number'>269</td><td class='line-content'>    (setf (nskk-barrier-count barrier)</td></tr>
<tr class='covered'><td class='line-number'>270</td><td class='line-content'>          (1+ (nskk-barrier-count barrier)))</td></tr>
<tr class=''><td class='line-number'>271</td><td class='line-content'></td></tr>
<tr class='covered'><td class='line-number'>272</td><td class='line-content'>    (if (&amp;gt;= (nskk-barrier-count barrier) (nskk-barrier-threshold barrier))</td></tr>
<tr class='covered'><td class='line-number'>273</td><td class='line-content'>        (progn</td></tr>
<tr class=''><td class='line-number'>274</td><td class='line-content'>          ;; 最後のスレッド: 全員に通知してリセット</td></tr>
<tr class='covered'><td class='line-number'>275</td><td class='line-content'>          (setf (nskk-barrier-count barrier) 0)</td></tr>
<tr class='covered'><td class='line-number'>276</td><td class='line-content'>          (condition-notify (nskk-barrier-condition barrier) t)</td></tr>
<tr class='covered'><td class='line-number'>277</td><td class='line-content'>          t)</td></tr>
<tr class=''><td class='line-number'>278</td><td class='line-content'>      ;; 待機</td></tr>
<tr class='covered'><td class='line-number'>279</td><td class='line-content'>      (condition-wait (nskk-barrier-condition barrier))</td></tr>
<tr class='covered'><td class='line-number'>280</td><td class='line-content'>      nil)))</td></tr>
<tr class=''><td class='line-number'>281</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>282</td><td class='line-content'>;;; Thread-Local Storage (簡易実装)</td></tr>
<tr class=''><td class='line-number'>283</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>284</td><td class='line-content'>(defvar nskk-tls--storage (make-hash-table :test 'equal)</td></tr>
<tr class=''><td class='line-number'>285</td><td class='line-content'>  &amp;quot;スレッドローカルストレージ。</td></tr>
<tr class=''><td class='line-number'>286</td><td class='line-content'>キーは (thread-id . variable-symbol) のペア。&amp;quot;)</td></tr>
<tr class=''><td class='line-number'>287</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>288</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>289</td><td class='line-content'>(defun nskk-tls-set (variable value)</td></tr>
<tr class=''><td class='line-number'>290</td><td class='line-content'>  &amp;quot;現在のスレッドで VARIABLE に VALUE を設定する。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>291</td><td class='line-content'>  (let ((key (cons (current-thread) variable)))</td></tr>
<tr class='covered'><td class='line-number'>292</td><td class='line-content'>    (puthash key value nskk-tls--storage)))</td></tr>
<tr class=''><td class='line-number'>293</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>294</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>295</td><td class='line-content'>(defun nskk-tls-get (variable &amp;optional default)</td></tr>
<tr class=''><td class='line-number'>296</td><td class='line-content'>  &amp;quot;現在のスレッドの VARIABLE の値を取得する。</td></tr>
<tr class=''><td class='line-number'>297</td><td class='line-content'>未設定の場合 DEFAULT を返す。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>298</td><td class='line-content'>  (let ((key (cons (current-thread) variable)))</td></tr>
<tr class='covered'><td class='line-number'>299</td><td class='line-content'>    (gethash key nskk-tls--storage default)))</td></tr>
<tr class=''><td class='line-number'>300</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>301</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>302</td><td class='line-content'>(defun nskk-tls-clear (variable)</td></tr>
<tr class=''><td class='line-number'>303</td><td class='line-content'>  &amp;quot;現在のスレッドの VARIABLE をクリアする。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>304</td><td class='line-content'>  (let ((key (cons (current-thread) variable)))</td></tr>
<tr class='covered'><td class='line-number'>305</td><td class='line-content'>    (remhash key nskk-tls--storage)))</td></tr>
<tr class=''><td class='line-number'>306</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>307</td><td class='line-content'>;;; ユーティリティ</td></tr>
<tr class=''><td class='line-number'>308</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>309</td><td class='line-content'>;;;###autoload</td></tr>
<tr class=''><td class='line-number'>310</td><td class='line-content'>(defun nskk-sync-primitives-available-p ()</td></tr>
<tr class=''><td class='line-number'>311</td><td class='line-content'>  &amp;quot;同期プリミティブが利用可能かチェックする。&amp;quot;</td></tr>
<tr class='covered'><td class='line-number'>312</td><td class='line-content'>  (and (fboundp 'make-mutex)</td></tr>
<tr class='covered'><td class='line-number'>313</td><td class='line-content'>       (fboundp 'make-condition-variable)</td></tr>
<tr class='covered'><td class='line-number'>314</td><td class='line-content'>       (fboundp 'mutex-lock)</td></tr>
<tr class='covered'><td class='line-number'>315</td><td class='line-content'>       (fboundp 'mutex-unlock)</td></tr>
<tr class='covered'><td class='line-number'>316</td><td class='line-content'>       (fboundp 'condition-wait)</td></tr>
<tr class='covered'><td class='line-number'>317</td><td class='line-content'>       (fboundp 'condition-notify)))</td></tr>
<tr class=''><td class='line-number'>318</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>319</td><td class='line-content'>(provide 'nskk-sync-primitives)</td></tr>
<tr class=''><td class='line-number'>320</td><td class='line-content'></td></tr>
<tr class=''><td class='line-number'>321</td><td class='line-content'>;;; nskk-sync-primitives.el ends here</td></tr>

    </table>
  </div>
  <div class='legend'>
    <div class='legend-item'><span class='legend-color' style='background: #e8f5e9;'></span>Covered</div>
    <div class='legend-item'><span class='legend-color' style='background: #ffebee;'></span>Uncovered</div>
    <div class='legend-item'><span class='legend-color' style='background: #fff3e0;'></span>1-Value</div>
    <div class='legend-item'><span class='legend-color' style='background: #f3e5f5;'></span>No-Return</div>
  </div>
</body>
</html>